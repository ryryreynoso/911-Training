<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>911 Training for Kids</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .container {
        max-width: 500px;
        width: 100%;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        padding: 25px;
        text-align: center;
    }

    .header h1 {
        font-size: 28px;
        margin-bottom: 5px;
    }

    .header p {
        font-size: 14px;
        opacity: 0.9;
    }

    .mode-selection {
        padding: 30px;
    }

    .mode-btn {
        width: 100%;
        padding: 20px;
        margin-bottom: 15px;
        border: none;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .learn-btn {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
    }

    .learn-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(52, 152, 219, 0.4);
    }

    .practice-btn {
        background: linear-gradient(135deg, #2ecc71, #27ae60);
        color: white;
    }

    .practice-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(46, 204, 113, 0.4);
    }

    .icon {
        font-size: 32px;
    }

    .lesson-content, .chat-interface {
        display: none;
        padding: 30px;
    }

    .lesson-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        border-left: 4px solid #3498db;
    }

    .lesson-card h3 {
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 18px;
    }

    .lesson-card p, .lesson-card ul {
        color: #555;
        line-height: 1.6;
        font-size: 15px;
    }

    .lesson-card ul {
        margin-left: 20px;
        margin-top: 10px;
    }

    .lesson-card li {
        margin-bottom: 8px;
    }

    .emergency-example {
        background: #ffe5e5;
        border-left-color: #e74c3c;
    }

    .non-emergency-example {
        background: #fff4e5;
        border-left-color: #f39c12;
    }

    .chat-messages {
        height: 400px;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 12px;
        margin-bottom: 20px;
    }

    .message {
        margin-bottom: 15px;
        display: flex;
        gap: 10px;
    }

    .message.operator {
        flex-direction: row;
    }

    .message.user {
        flex-direction: row-reverse;
    }

    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
    }

    .operator .message-avatar {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    .user .message-avatar {
        background: linear-gradient(135deg, #3498db, #2980b9);
    }

    .message-content {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 15px;
        line-height: 1.4;
    }

    .operator .message-content {
        background: white;
        color: #2c3e50;
    }

    .user .message-content {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
    }

    .input-area {
        display: flex;
        gap: 10px;
    }

    .input-area input {
        flex: 1;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 15px;
        outline: none;
        transition: border-color 0.3s;
    }

    .input-area input:focus {
        border-color: #3498db;
    }

    .send-btn {
        padding: 15px 25px;
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .send-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
    }

    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .back-btn {
        width: 100%;
        padding: 15px;
        background: #95a5a6;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 20px;
        transition: all 0.3s;
    }

    .back-btn:hover {
        background: #7f8c8d;
    }

    .scenario-selection {
        display: none;
        padding: 30px;
    }

    .scenario-btn {
        width: 100%;
        padding: 18px;
        margin-bottom: 12px;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        text-align: left;
        color: #2c3e50;
    }

    .scenario-btn:hover {
        border-color: #3498db;
        transform: translateX(5px);
    }

    .typing-indicator {
        display: none;
        padding: 12px 16px;
        background: white;
        border-radius: 12px;
        width: fit-content;
    }

    .typing-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #95a5a6;
        border-radius: 50%;
        margin: 0 2px;
        animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-10px);
        }
    }

    .feedback {
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin-top: 20px;
        display: none;
    }

    .feedback h3 {
        margin-bottom: 10px;
        font-size: 18px;
    }

    .feedback p {
        line-height: 1.6;
        font-size: 15px;
    }

    .feedback.show {
        display: block;
    }

    /* Voice Call Interface Styles */
    .voice-call-interface {
        padding: 30px;
        text-align: center;
    }

    .voice-call-container {
        max-width: 400px;
        margin: 0 auto;
    }

    .call-avatar {
        width: 120px;
        height: 120px;
        margin: 0 auto 20px;
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 60px;
        box-shadow: 0 10px 30px rgba(231, 76, 60, 0.3);
    }

    .call-name {
        font-size: 28px;
        color: #2c3e50;
        margin-bottom: 10px;
    }

    .call-status {
        font-size: 16px;
        color: #7f8c8d;
        margin-bottom: 30px;
    }

    .call-transcript {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        min-height: 200px;
        max-height: 300px;
        overflow-y: auto;
        text-align: left;
    }

    .transcript-message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 8px;
        line-height: 1.6;
    }

    .operator-voice {
        background: white;
        border-left: 4px solid #e74c3c;
    }

    .user-voice {
        background: #e3f2fd;
        border-left: 4px solid #3498db;
    }

    .transcript-message strong {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
    }

    .voice-controls {
        margin-bottom: 20px;
    }

    .voice-btn {
        width: 100%;
        padding: 25px;
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        border: none;
        border-radius: 50px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .voice-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 25px rgba(231, 76, 60, 0.4);
    }

    .voice-btn.listening {
        background: linear-gradient(135deg, #2ecc71, #27ae60);
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }

    .mic-icon {
        font-size: 28px;
    }

    .listening-text {
        color: #e74c3c;
        font-weight: 600;
        font-size: 16px;
        margin-top: 15px;
        animation: blink 1s infinite;
    }

    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .user-speech {
        color: #3498db;
        font-size: 16px;
        margin-top: 10px;
        font-style: italic;
        min-height: 20px;
    }

    .end-call-btn {
        width: 80%;
        padding: 15px;
        background: #95a5a6;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .end-call-btn:hover {
        background: #7f8c8d;
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® 911 Training</h1>
            <p>Learn when and how to call for help</p>
        </div>

```
    <!-- Mode Selection -->
    <div class="mode-selection" id="modeSelection">
        <button class="mode-btn learn-btn" onclick="showLesson()">
            <span class="icon">üìö</span>
            <span>Learn About 911</span>
        </button>
        <button class="mode-btn practice-btn" onclick="showScenarios()">
            <span class="icon">üé≠</span>
            <span>Practice Scenarios</span>
        </button>
        <button class="mode-btn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white;" onclick="startFreeChat()">
            <span class="icon">üí¨</span>
            <span>Free Practice Call</span>
        </button>
        <button class="mode-btn" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white;" onclick="startVoiceCall()">
            <span class="icon">üìû</span>
            <span>Voice Call Practice</span>
        </button>
    </div>

    <!-- Lesson Content -->
    <div class="lesson-content" id="lessonContent">
        <div class="lesson-card">
            <h3>What is 911?</h3>
            <p>911 is a special phone number for EMERGENCIES ONLY. When you call 911, you'll talk to a trained operator who will send help right away.</p>
        </div>

        <div class="lesson-card emergency-example">
            <h3>‚úÖ When to Call 911</h3>
            <p>Call 911 when someone needs help RIGHT NOW:</p>
            <ul>
                <li>Someone is hurt badly and bleeding a lot</li>
                <li>Someone can't breathe or is having trouble breathing</li>
                <li>There's a fire in your home</li>
                <li>Someone is breaking into your house</li>
                <li>You see a serious car accident</li>
                <li>Someone is unconscious (won't wake up)</li>
            </ul>
        </div>

        <div class="lesson-card non-emergency-example">
            <h3>‚ùå When NOT to Call 911</h3>
            <p>Don't call 911 for things that aren't emergencies:</p>
            <ul>
                <li>You lost your toy or pet</li>
                <li>You want to ask a question</li>
                <li>You have a small cut or scrape</li>
                <li>You're bored or want to talk</li>
                <li>Your homework is too hard</li>
                <li>You want to see the fire trucks</li>
            </ul>
        </div>

        <div class="lesson-card">
            <h3>What to Say When You Call 911</h3>
            <p>The operator will ask you important questions:</p>
            <ul>
                <li><strong>Where are you?</strong> Know your address or location</li>
                <li><strong>What happened?</strong> Explain the emergency clearly</li>
                <li><strong>Who needs help?</strong> Tell them who is hurt or in danger</li>
                <li><strong>Your name and phone number</strong></li>
            </ul>
            <p style="margin-top: 10px;"><strong>Important:</strong> Stay on the phone until the operator says it's okay to hang up!</p>
        </div>

        <button class="back-btn" onclick="showModeSelection()">Back to Main Menu</button>
    </div>

    <!-- Scenario Selection -->
    <div class="scenario-selection" id="scenarioSelection">
        <h2 style="margin-bottom: 20px; color: #2c3e50;">Choose a Scenario</h2>
        <button class="scenario-btn" onclick="startScenario('fire')">
            üî• House Fire Emergency
        </button>
        <button class="scenario-btn" onclick="startScenario('injury')">
            ü§ï Someone is Hurt
        </button>
        <button class="scenario-btn" onclick="startScenario('non-emergency')">
            üêï Lost Pet (Not an Emergency)
        </button>
        <button class="scenario-btn" onclick="startScenario('breathing')">
            üò∞ Trouble Breathing
        </button>
        <button class="scenario-btn" onclick="startScenario('stranger')">
            üë§ Stranger at the Door
        </button>
        <button class="back-btn" onclick="showModeSelection()">Back to Main Menu</button>
    </div>

    <!-- Chat Interface -->
    <div class="chat-interface" id="chatInterface">
        <div class="chat-messages" id="chatMessages">
            <div class="message operator">
                <div class="message-avatar">üëÆ</div>
                <div class="message-content">911, what's your emergency?</div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
        </div>
        <div class="feedback" id="feedback">
            <h3>üìù Feedback</h3>
            <p id="feedbackText"></p>
        </div>
        <button class="back-btn" onclick="endCall()">End Call</button>
    </div>

    <!-- Voice Call Interface -->
    <div class="voice-call-interface" id="voiceCallInterface" style="display: none;">
        <div class="voice-call-container">
            <div class="call-avatar">üëÆ</div>
            <h2 class="call-name">911 Operator</h2>
            <p class="call-status" id="callStatus">Connecting...</p>
            
            <div class="call-transcript" id="callTranscript">
                <div class="transcript-message operator-voice">
                    <strong>Operator:</strong> <span id="operatorText">911, what's your emergency?</span>
                </div>
            </div>
            
            <div class="voice-controls">
                <button class="voice-btn mic-btn" id="micBtn" onclick="toggleMicrophone()">
                    <span class="mic-icon">üé§</span>
                    <span class="mic-text">Tap to Speak</span>
                </button>
                <p class="listening-text" id="listeningText" style="display: none;">Listening...</p>
                <p class="user-speech" id="userSpeech"></p>
            </div>
            
            <button class="end-call-btn" onclick="endVoiceCall()">End Call</button>
        </div>
    </div>
</div>

<script>
    let currentScenario = null;
    let conversationHistory = [];
    let callEnded = false;
    
    // Voice recognition setup
    let recognition = null;
    let synthesis = window.speechSynthesis;
    let isListening = false;
    let voiceCallActive = false;

    const scenarios = {
        'fire': {
            context: 'There is a fire in the kitchen',
            isEmergency: true,
            tips: 'Great job! In a fire emergency, always: 1) Get out of the house first, 2) Call 911 from a safe place outside, 3) Never go back inside for toys or pets.'
        },
        'injury': {
            context: 'Someone fell and is bleeding from their head',
            isEmergency: true,
            tips: 'Excellent! For serious injuries: 1) Stay calm, 2) Don\'t move the injured person, 3) Apply gentle pressure to stop bleeding if safe, 4) Wait for help to arrive.'
        },
        'non-emergency': {
            context: 'Your pet dog ran away and you can\'t find it',
            isEmergency: false,
            tips: 'Good thinking! This is NOT a 911 emergency. Instead: 1) Tell your parents or a trusted adult, 2) Call local animal control (not 911), 3) Check with neighbors, 4) Make "lost pet" posters.'
        },
        'breathing': {
            context: 'Someone is having trouble breathing and their face is turning blue',
            isEmergency: true,
            tips: 'Perfect! Breathing problems are always emergencies. Remember: 1) Call 911 immediately, 2) Make sure the person is sitting up if possible, 3) Stay with them until help arrives.'
        },
        'stranger': {
            context: 'A stranger is trying to break into your house',
            isEmergency: true,
            tips: 'Excellent response! If someone is breaking in: 1) Hide in a safe room with a lock, 2) Call 911 quietly, 3) Don\'t confront the person, 4) Give the operator your exact address.'
        }
    };

    function showLesson() {
        document.getElementById('modeSelection').style.display = 'none';
        document.getElementById('lessonContent').style.display = 'block';
    }

    function showScenarios() {
        document.getElementById('modeSelection').style.display = 'none';
        document.getElementById('scenarioSelection').style.display = 'block';
    }

    function showModeSelection() {
        document.getElementById('modeSelection').style.display = 'block';
        document.getElementById('lessonContent').style.display = 'none';
        document.getElementById('scenarioSelection').style.display = 'none';
        document.getElementById('chatInterface').style.display = 'none';
    }

    function startScenario(scenario) {
        currentScenario = scenario;
        conversationHistory = [];
        callEnded = false;
        window.conversationContext = null; // Reset context
        
        document.getElementById('scenarioSelection').style.display = 'none';
        document.getElementById('chatInterface').style.display = 'block';
        document.getElementById('feedback').classList.remove('show');
        
        // Reset chat
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = `
            <div class="message operator">
                <div class="message-avatar">üëÆ</div>
                <div class="message-content">911, what's your emergency?</div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        `;
        
        document.getElementById('userInput').value = '';
        document.getElementById('userInput').disabled = false;
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('userInput').focus();
    }

    function startFreeChat() {
        currentScenario = 'free';
        conversationHistory = [];
        callEnded = false;
        window.conversationContext = null; // Reset context
        
        document.getElementById('modeSelection').style.display = 'none';
        document.getElementById('chatInterface').style.display = 'block';
        document.getElementById('feedback').classList.remove('show');
        
        // Reset chat
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = `
            <div class="message operator">
                <div class="message-avatar">üëÆ</div>
                <div class="message-content">911, what's your emergency?</div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        `;
        
        document.getElementById('userInput').value = '';
        document.getElementById('userInput').disabled = false;
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('userInput').focus();
    }
    
    function startVoiceCall() {
        currentScenario = 'voice';
        conversationHistory = [];
        callEnded = false;
        voiceCallActive = true;
        window.conversationContext = null;
        
        // Check if browser supports speech recognition
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert('Sorry, your browser doesn\'t support voice recognition. Please use Chrome, Safari, or Edge.');
            return;
        }
        
        // Request microphone permission first
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    // Permission granted, stop the stream and proceed
                    stream.getTracks().forEach(track => track.stop());
                    initializeVoiceCall();
                })
                .catch(function(err) {
                    alert('Microphone access is required for voice calls. Please allow microphone access in your browser settings and try again.');
                    console.error('Microphone permission denied:', err);
                });
        } else {
            // Fallback - try to initialize anyway
            initializeVoiceCall();
        }
    }
    
    function initializeVoiceCall() {
        // Initialize speech recognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            handleVoiceInput(transcript);
        };
        
        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            
            if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                alert('Microphone access denied. Please:\n\n1. Tap the lock icon in your browser address bar\n2. Enable microphone permissions\n3. Reload the page and try again');
                endVoiceCall();
            } else if (event.error === 'no-speech') {
                document.getElementById('callStatus').textContent = 'Didn\'t hear anything. Try again.';
            } else {
                document.getElementById('callStatus').textContent = 'Error: ' + event.error;
            }
            
            document.getElementById('listeningText').style.display = 'none';
            document.getElementById('micBtn').classList.remove('listening');
            isListening = false;
        };
        
        recognition.onend = function() {
            document.getElementById('listeningText').style.display = 'none';
            document.getElementById('micBtn').classList.remove('listening');
            isListening = false;
        };
        
        // Show voice interface
        document.getElementById('modeSelection').style.display = 'none';
        document.getElementById('voiceCallInterface').style.display = 'block';
        document.getElementById('callStatus').textContent = 'Connected';
        
        // Speak first message
        setTimeout(() => {
            speakOperatorMessage("911, what's your emergency?");
        }, 1000);
    }
    
    function toggleMicrophone() {
        if (callEnded) return;
        
        if (!isListening) {
            // Start listening
            isListening = true;
            document.getElementById('micBtn').classList.add('listening');
            document.getElementById('listeningText').style.display = 'block';
            document.getElementById('userSpeech').textContent = '';
            
            const micTextElement = document.querySelector('.mic-text');
            if (micTextElement) {
                micTextElement.textContent = 'Listening...';
            }
            
            recognition.start();
        } else {
            // Stop listening
            recognition.stop();
            isListening = false;
        }
    }
    
    function handleVoiceInput(transcript) {
        console.log('User said:', transcript);
        
        // Display what user said
        document.getElementById('userSpeech').textContent = transcript;
        
        // Add to transcript
        const transcriptDiv = document.getElementById('callTranscript');
        const userMsg = document.createElement('div');
        userMsg.className = 'transcript-message user-voice';
        userMsg.innerHTML = `<strong>You:</strong> <span>${transcript}</span>`;
        transcriptDiv.appendChild(userMsg);
        transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
        
        // Add to conversation history
        conversationHistory.push({ role: 'user', content: transcript });
        
        // Get operator response
        setTimeout(() => {
            const response = getRuleBasedResponse();
            speakOperatorMessage(response);
            
            // Add to transcript
            const operatorMsg = document.createElement('div');
            operatorMsg.className = 'transcript-message operator-voice';
            operatorMsg.innerHTML = `<strong>Operator:</strong> <span>${response}</span>`;
            transcriptDiv.appendChild(operatorMsg);
            transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
            
            document.getElementById('operatorText').textContent = response;
        }, 1000);
    }
    
    function speakOperatorMessage(message) {
        // Cancel any ongoing speech
        synthesis.cancel();
        
        // Create utterance
        const utterance = new SpeechSynthesisUtterance(message);
        utterance.rate = 0.9; // Slightly slower for clarity
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        
        // Try to use a female voice if available
        const voices = synthesis.getVoices();
        const femaleVoice = voices.find(voice => 
            voice.name.includes('Female') || 
            voice.name.includes('Samantha') ||
            voice.name.includes('Karen')
        );
        if (femaleVoice) {
            utterance.voice = femaleVoice;
        }
        
        utterance.onend = function() {
            // Enable microphone after operator finishes speaking
            if (!callEnded && voiceCallActive) {
                document.getElementById('callStatus').textContent = 'Your turn to speak';
            }
        };
        
        document.getElementById('callStatus').textContent = 'Operator speaking...';
        synthesis.speak(utterance);
    }
    
    function endVoiceCall() {
        voiceCallActive = false;
        callEnded = true;
        
        if (recognition) {
            recognition.stop();
        }
        synthesis.cancel();
        
        // Show feedback
        const context = window.conversationContext || {};
        let feedbackText = '';
        
        if (context.confirmedEmergency) {
            if (context.hasLocation) {
                feedbackText = '‚úÖ Excellent job! You clearly explained the emergency and gave your location. In a real emergency, this is exactly what you need to do!';
            } else {
                feedbackText = 'üëç Good attempt! You explained the emergency well. Remember to always give your address or location so help can reach you!';
            }
        } else {
            feedbackText = 'üìö Remember: 911 is ONLY for real emergencies. Use voice calls to practice speaking clearly and calmly in emergency situations.';
        }
        
        alert(feedbackText);
        
        setTimeout(() => {
            showModeSelection();
            document.getElementById('voiceCallInterface').style.display = 'none';
        }, 500);
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    async function sendMessage() {
        const input = document.getElementById('userInput');
        const message = input.value.trim();
        
        if (!message || callEnded) return;
        
        // Add user message
        addMessage(message, 'user');
        input.value = '';
        
        // Disable input while processing
        input.disabled = true;
        document.getElementById('sendBtn').disabled = true;
        
        // Show typing indicator
        document.getElementById('typingIndicator').style.display = 'block';
        
        // Add to conversation history
        conversationHistory.push({ role: 'user', content: message });
        
        // Small delay to make it feel more natural
        await new Promise(resolve => setTimeout(resolve, 800));
        
        // Get AI response
        const response = getRuleBasedResponse();
        
        // Add assistant response to history
        conversationHistory.push({ role: 'assistant', content: response });
        
        // Hide typing indicator
        document.getElementById('typingIndicator').style.display = 'none';
        
        // Add operator message
        addMessage(response, 'operator');
        
        // Re-enable input
        input.disabled = false;
        document.getElementById('sendBtn').disabled = false;
        input.focus();
    }

    function addMessage(text, sender) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        const avatar = sender === 'operator' ? 'üëÆ' : 'üßí';
        
        messageDiv.innerHTML = `
            <div class="message-avatar">${avatar}</div>
            <div class="message-content">${text}</div>
        `;
        
        chatMessages.insertBefore(messageDiv, document.getElementById('typingIndicator'));
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function getAIResponse() {
        // Use rule-based fallback system instead of API
        return getRuleBasedResponse();
    }
    
    function getRuleBasedResponse() {
        const userMessage = conversationHistory[conversationHistory.length - 1].content.toLowerCase();
        // Count only user messages (odd indices in conversationHistory)
        const messageCount = Math.ceil(conversationHistory.length / 2);
        
        console.log('Message count:', messageCount, 'History length:', conversationHistory.length);
        
        // Initialize or get conversation context
        if (!window.conversationContext) {
            window.conversationContext = {
                hasLocation: false,
                knowsIssue: false,
                issueType: null,
                confirmedEmergency: null,
                askedFollowUp: false,
                userName: null,
                seemsScared: false,
                seemsUnsure: false,
                mentionedParent: false,
                redirectAttempts: 0,
                readyToEnd: false
            };
        }
        
        const context = window.conversationContext;
        
        // Detect emotional cues
        const scaredWords = ['scared', 'afraid', 'terrified', 'help', 'please', 'worried', 'nervous'];
        const unsureWords = ['i don\'t know', 'maybe', 'i think', 'kind of', 'sort of', 'um', 'uh'];
        
        if (scaredWords.some(word => userMessage.includes(word))) {
            context.seemsScared = true;
        }
        if (unsureWords.some(word => userMessage.includes(word))) {
            context.seemsUnsure = true;
        }
        
        // Detect emergency types
        const emergencyTypes = {
            fire: ['fire', 'burning', 'smoke', 'flames', 'burnt'],
            injury: ['hurt', 'bleeding', 'blood', 'fell', 'injured', 'broken', 'cut', 'pain', 'wound'],
            breathing: ['breathe', 'breathing', 'choking', 'choke', 'air', 'can\'t breathe'],
            crime: ['break in', 'breaking in', 'stranger', 'robber', 'theft', 'attack', 'someone here', 'intruder'],
            medical: ['sick', 'chest', 'heart', 'seizure', 'unconscious', 'passed out', 'fainted', 'dizzy', 'throwing up']
        };
        
        const minorIssues = ['pizza', 'food', 'hungry', 'order', 'homework', 'lost pet', 'dog ran', 'cat missing', 'toy', 'bored', 'lonely', 'netflix', 'tv', 'game', 'scared of dark', 'nightmare', 'can\'t sleep'];
        
        // Detect parent/adult mentions
        if (userMessage.includes('mom') || userMessage.includes('dad') || userMessage.includes('parent') || userMessage.includes('adult')) {
            context.mentionedParent = true;
        }
        
        // Check for name
        const namePatterns = ['my name is', 'i\'m ', 'im ', 'this is ', 'call me', 'i am '];
        if (!context.userName && namePatterns.some(pattern => userMessage.includes(pattern))) {
            context.userName = true;
        }
        
        // Detect emergency type
        if (!context.issueType) {
            for (const [type, keywords] of Object.entries(emergencyTypes)) {
                if (keywords.some(keyword => userMessage.includes(keyword))) {
                    context.issueType = type;
                    context.confirmedEmergency = true;
                    context.knowsIssue = true;
                    break;
                }
            }
        }
        
        // Check for location
        const locationWords = ['street', 'avenue', 'road', 'drive', 'lane', 'boulevard', 'house', 'home', 'school', 'park', 'store', 'apartment', 'building'];
        const hasNumber = /\d+/.test(userMessage);
        if ((hasNumber && locationWords.some(word => userMessage.includes(word))) || 
            userMessage.includes('at ') || 
            userMessage.includes('address')) {
            context.hasLocation = true;
        }
        
        let response = '';
        
        // ==================== MESSAGE 1 ====================
        if (messageCount === 1) {
            // Greetings or very vague
            if (userMessage.match(/^(hi|hello|hey|um|uh|help)$/)) {
                return "Hi there. It's okay, I'm here to help. Can you tell me what's going on?";
            }
            
            // Just gives name
            if (context.userName && !context.knowsIssue) {
                return "Okay, thank you. Now can you tell me why you're calling? What's happening?";
            }
            
            // Clear emergency
            if (context.issueType && context.confirmedEmergency) {
                if (context.seemsScared) {
                    if (context.issueType === 'fire') {
                        return "There's a fire? Okay, I need you to stay calm. Are you outside the house right now?";
                    } else if (context.issueType === 'injury') {
                        return "Someone's hurt? Alright, I'm here to help. First, are YOU okay? Are you hurt too?";
                    } else if (context.issueType === 'breathing') {
                        return "They're having trouble breathing? Okay, stay with me. Are they awake? Can they hear you?";
                    } else if (context.issueType === 'crime') {
                        return "There's someone there who shouldn't be? Are you somewhere safe right now? Are you hidden?";
                    } else {
                        return "I understand. You're doing great by calling. Are you safe right now?";
                    }
                } else {
                    if (context.issueType === 'fire') {
                        return "Okay, there's a fire. Where is the fire? Is everyone out of the building?";
                    } else if (context.issueType === 'injury') {
                        return "Someone is hurt. Can you tell me who's hurt and what happened?";
                    } else {
                        return "I hear you. Tell me where you are so I can send help right away.";
                    }
                }
            }
            
            // Minor issue detected
            if (minorIssues.some(word => userMessage.includes(word))) {
                if (userMessage.includes('pizza') || userMessage.includes('food') || userMessage.includes('hungry')) {
                    return "I understand you're hungry. But 911 is for emergencies, like if someone is really hurt. Is anyone hurt or in danger at your house right now?";
                } else if (userMessage.includes('pet')) {
                    return "Your pet is missing? I know that's really upsetting. But let me ask you - is anyone hurt? Is there any danger happening right now?";
                } else if (userMessage.includes('nightmare') || userMessage.includes('scared of dark')) {
                    return "You're scared? That's okay, everyone gets scared sometimes. But 911 is for emergencies. Is there something dangerous happening? Is someone trying to hurt you?";
                } else if (userMessage.includes('homework')) {
                    return "Homework can be tough! But 911 is for emergencies only. Let me check - is anyone hurt or sick at home? Is there any emergency?";
                } else {
                    return "I hear you. But 911 is for really serious emergencies. Can you tell me - is anyone hurt? Is there a fire? Is something dangerous happening?";
                }
            }
            
            // Vague or confused
            context.seemsUnsure = true;
            return "It's okay, take a breath. You can tell me. What made you want to call 911? Is something wrong?";
        }
        
        // ==================== MESSAGE 2 ====================
        else if (messageCount === 2) {
            // They confirm emergency after minor issue question
            if (context.confirmedEmergency === null && context.issueType) {
                context.confirmedEmergency = true;
                return "Okay, that IS an emergency. I'm going to help you. Where are you right now? Can you tell me your address or what place you're at?";
            }
            
            // They say yes to follow-up question
            if (userMessage.includes('yes') || userMessage.includes('yeah')) {
                if (!context.knowsIssue) {
                    return "Alright. Tell me what's happening. Is someone hurt? Is there a fire? What's the emergency?";
                } else if (context.confirmedEmergency && !context.hasLocation) {
                    return "Good. Now I need to know where you are. What's your address? What street do you live on?";
                }
            }
            
            // They say no
            if (userMessage.includes('no') || userMessage.includes('nope')) {
                if (!context.confirmedEmergency && context.redirectAttempts === 0) {
                    context.redirectAttempts++;
                    context.confirmedEmergency = false; // Only set to false after they explicitly say no
                    return "Okay, so nobody is hurt and there's no emergency. Can you tell me why you called 911 today?";
                }
            }
            
            // Now reveals emergency
            if (context.issueType && context.confirmedEmergency) {
                if (context.issueType === 'fire') {
                    return "A fire - okay. Are you and everyone else outside and safe? Where is your house?";
                } else if (context.issueType === 'injury') {
                    return "They're hurt. Is it bad? Are they bleeding a lot? Where are you?";
                } else if (context.issueType === 'breathing') {
                    return "Trouble breathing is serious. Is their face turning blue? Do you know your address?";
                } else {
                    return "I understand. I'm going to send help. What's your address? Or are you at home, school, or somewhere else?";
                }
            }
            
            // Gave location but still unclear on issue
            if (context.hasLocation && !context.knowsIssue) {
                return "Okay, I've got your location. Now help me understand what's happening. Is someone hurt? Did something happen?";
            }
            
            // Still being vague
            if (!context.knowsIssue && !context.hasLocation) {
                return "I'm listening. You can tell me anything. Is this about someone being hurt? Or a fire? Or something else?";
            }
            
            // Gave more detail about minor issue
            if (!context.knowsIssue && minorIssues.some(word => userMessage.includes(word))) {
                context.redirectAttempts++;
                return "I see. That's not what 911 is for. 911 is only for big emergencies - like if someone can't breathe, or there's a fire, or someone is really hurt. Is your mom or dad home? Can you talk to them about this?";
            }
            
            return "Tell me more. What exactly is happening right now?";
        }
        
        // ==================== MESSAGE 3 ====================
        else if (messageCount === 3) {
            // Confirmed emergency, gathering remaining info
            if (context.confirmedEmergency && context.knowsIssue) {
                if (context.hasLocation) {
                    if (context.issueType === 'fire') {
                        return "Okay. Help is coming right now - fire trucks are on the way. Stay outside and stay away from the building. Are you with other people?";
                    } else if (context.issueType === 'injury') {
                        return "An ambulance is coming to you right now. Don't try to move the person who's hurt. Can you stay with them?";
                    } else if (context.issueType === 'breathing') {
                        return "Paramedics are coming as fast as they can. If they can sit up, try to help them sit up. Help will be there soon.";
                    } else if (context.issueType === 'crime') {
                        return "Police are on their way right now. Stay hidden and stay quiet. Keep this phone with you.";
                    } else {
                        return "Help is on the way to you. You did exactly the right thing by calling 911.";
                    }
                } else {
                    return "I need your location to send help. Can you look outside and see a street sign? Or tell me if you're at home, at school, or somewhere else?";
                }
            }
            
            // Still determining if emergency
            if (!context.knowsIssue && context.redirectAttempts < 2) {
                context.redirectAttempts++;
                return "I'm trying to understand so I can help you. Is anyone having trouble breathing? Is anyone bleeding? Is there a fire you can see?";
            }
            
            // Non-emergency but being thorough
            if (context.confirmedEmergency === false && context.redirectAttempts >= 2) {
                context.redirectAttempts++;
                if (context.mentionedParent) {
                    return "So this isn't an emergency, which is good - everyone's safe! For things like this, you should talk to your parents instead of calling 911. Are they home right now?";
                } else {
                    return "I understand now. This isn't a 911 emergency, which means everyone is safe - that's good! 911 is only for when someone needs help RIGHT NOW. For other stuff, you should talk to your parents. Is there a grown-up at home with you?";
                }
            }
            
            // Still unclear
            return "Let's try this - can you tell me in one sentence what's wrong? Like 'my brother fell' or 'there's smoke'?";
        }
        
        // ==================== MESSAGE 4 ====================
        else if (messageCount === 4) {
            // Emergency with location - continue support
            if (context.confirmedEmergency && context.hasLocation && context.knowsIssue) {
                return "You're doing great. The emergency responders will be there very soon. Just stay where you are.";
            }
            
            // Emergency but still missing location
            if (context.confirmedEmergency && !context.hasLocation) {
                return "I'm sending help to find you. Emergency services are on their way. Do you see any landmarks or signs nearby?";
            }
            
            // Non-emergency - prepare to end
            if (context.confirmedEmergency === false || context.redirectAttempts >= 3) {
                context.readyToEnd = true;
                return "Alright. Remember, only call 911 if someone is hurt, can't breathe, there's a fire, or something really dangerous. For everything else, talk to your parents. Okay?";
            }
            
            // One more attempt to understand
            return "Help me out here. Just tell me yes or no: Is this a real emergency where someone needs help right now?";
        }
        
        // ==================== MESSAGE 5 ====================
        else if (messageCount === 5) {
            // Emergency continues
            if (context.confirmedEmergency && context.knowsIssue) {
                return "Help should be arriving now. You did everything right. Stay safe.";
            }
            
            // Non-emergency - prepare for final message
            if (context.readyToEnd || context.redirectAttempts >= 3) {
                return "I have to go now. Take care, and talk to your parents about this. Okay?";
            }
            
            return "Is there anything else I should know about this situation?";
        }
        
        // ==================== MESSAGE 6 ====================
        else if (messageCount === 6) {
            // Non-emergency final response before ending
            if (context.readyToEnd || context.redirectAttempts >= 3 || context.confirmedEmergency === false) {
                setTimeout(() => endCallWithFeedback(), 2000);
                return "Alright. Be safe. Goodbye.";
            }
            
            // Emergency wrapping up
            if (context.confirmedEmergency && context.knowsIssue) {
                setTimeout(() => endCallWithFeedback(), 2000);
                return "Help is there now. You did great. Everything will be okay.";
            }
            
            return "Okay, I understand. Is there anything else?";
        }
        
        // ==================== MESSAGE 7+ ====================
        else {
            // End any conversation at this point
            setTimeout(() => endCallWithFeedback(), 1500);
            if (context.confirmedEmergency && context.knowsIssue) {
                return "Emergency services have arrived. You're safe now. Goodbye.";
            } else {
                return "I need to go help other people now. Take care. Goodbye.";
            }
        }
    }
    
    function endCallWithFeedback() {
        callEnded = true;
        
        const context = window.conversationContext || {};
        
        let feedbackText = '';
        
        if (currentScenario === 'free') {
            if (context.confirmedEmergency) {
                if (context.hasLocation) {
                    feedbackText = '‚úÖ Excellent job! You: 1) Clearly explained the emergency, 2) Gave your location, 3) Stayed calm. In a real emergency, operators need to know WHAT happened and WHERE you are. You did great!';
                } else {
                    feedbackText = 'üëç Good attempt! You explained the emergency well, but remember to always give your ADDRESS or location. The operator can\'t send help without knowing where you are!';
                }
            } else if (context.suspectedNonEmergency) {
                feedbackText = 'üìö Good learning experience! This wasn\'t a real emergency. Remember: 911 is ONLY for situations where someone is hurt, there\'s a fire, a crime is happening, or someone can\'t breathe. For other problems, talk to your parents or a trusted adult.';
            } else {
                feedbackText = 'üí° Remember: When you call 911, be clear about what the emergency is right away. Say things like "There\'s a fire" or "Someone is hurt" so the operator knows how to help you quickly.';
            }
        } else {
            const scenario = scenarios[currentScenario];
            feedbackText = scenario.tips;
        }
        
        document.getElementById('feedbackText').textContent = feedbackText;
        document.getElementById('feedback').classList.add('show');
        
        document.getElementById('userInput').disabled = true;
        document.getElementById('sendBtn').disabled = true;
        
        // Reset context for next call
        window.conversationContext = null;
    }

    function endCallWithFeedback() {
        callEnded = true;
        
        if (currentScenario === 'free') {
            document.getElementById('feedbackText').textContent = 'Great practice! Remember: 911 is ONLY for real emergencies. Using 911 for non-emergencies can delay help for people who really need it. Always think: Is someone hurt? Is there a fire? Is someone in danger? If not, don\'t call 911!';
        } else {
            const scenario = scenarios[currentScenario];
            document.getElementById('feedbackText').textContent = scenario.tips;
        }
        
        document.getElementById('feedback').classList.add('show');
        
        document.getElementById('userInput').disabled = true;
        document.getElementById('sendBtn').disabled = true;
    }

    function endCall() {
        if (!callEnded) {
            const context = window.conversationContext || {};
            
            if (currentScenario === 'free') {
                if (context.confirmedEmergency) {
                    if (context.hasLocation) {
                        document.getElementById('feedbackText').textContent = '‚úÖ Excellent job! You: 1) Clearly explained the emergency, 2) Gave your location, 3) Stayed calm. In a real emergency, operators need to know WHAT happened and WHERE you are. You did great!';
                    } else {
                        document.getElementById('feedbackText').textContent = 'üëç Good attempt! You explained the emergency well, but remember to always give your ADDRESS or location. The operator can\'t send help without knowing where you are!';
                    }
                } else {
                    document.getElementById('feedbackText').textContent = 'üìö Remember: 911 is ONLY for real emergencies. Using 911 for non-emergencies can delay help for people who really need it. Always think: Is someone hurt? Is there a fire? Is someone in danger? If not, don\'t call 911!';
                }
            } else {
                const scenario = scenarios[currentScenario];
                document.getElementById('feedbackText').textContent = scenario.tips;
            }
            document.getElementById('feedback').classList.add('show');
        }
        
        // Reset context
        window.conversationContext = null;
        
        setTimeout(() => {
            if (currentScenario === 'free') {
                showModeSelection();
            } else {
                showScenarios();
            }
        }, 3000);
    }
</script>
```

</body>
</html>